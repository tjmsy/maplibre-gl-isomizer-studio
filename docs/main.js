import { generateStyle } from "https://cdn.jsdelivr.net/gh/tjmsy/maplibre-gl-isomizer@0.3/src/generateStyle.js";
import { addImages } from "https://cdn.jsdelivr.net/gh/tjmsy/maplibre-gl-isomizer@0.3/src/addImages.js";
import { addSources } from "https://cdn.jsdelivr.net/gh/tjmsy/maplibre-gl-isomizer@0.3/src/addSources.js";
import { addLayers } from "https://cdn.jsdelivr.net/gh/tjmsy/maplibre-gl-isomizer@0.3/src/addLayers.js";

/* -------------------------
 * Constants
 * ------------------------- */

const sampleProjectUrl = "https://cdn.jsdelivr.net/gh/tjmsy/isomizer-projectfiles@0.3/projects/global/project-config.yml";

const fileToYamlKey = {
  "design-plan.yml": "designPlan",
  "symbol-palette.yml": "symbolPalette",
  "color-palette.yml": "colorPalette",
  "image-palette.yml": "imagePalette",
};

const RenderMode = {
  FULL: "full",
  STYLE_ONLY: "style",
  IMAGES: "images",
};

/* -------------------------
 * State
 * ------------------------- */

let map = null;
let projectConfig = null;

const yamlState = {
  designPlan: { text: "", parsed: null },
  symbolPalette: { text: "", parsed: null },
  colorPalette: { text: "", parsed: null },
  imagePalette: { text: "", parsed: null },
};

/* -------------------------
 * YAML helpers
 * ------------------------- */

function setYaml(key, text) {
  yamlState[key].text = text;
  yamlState[key].parsed = jsyaml.load(text);
}

function getYamlParsed(key) {
  return yamlState[key].parsed;
}

function canRender() {
  return (
    yamlState.designPlan.parsed &&
    yamlState.symbolPalette.parsed &&
    yamlState.colorPalette.parsed &&
    yamlState.imagePalette.parsed
  );
}

/* -------------------------
 * ZIP save / load
 * ------------------------- */

async function saveProjectAsZip() {
  const zip = new JSZip();

  Object.entries(fileToYamlKey).forEach(([file, key]) => {
    zip.file(file, yamlState[key].text);
  });

  const projectConfig = {
    project: {
      name: "New Project",
      description: "Generated by ISOMizer Studio",
    },
    map: {
      center: map.getCenter().toArray(),
      zoom: map.getZoom(),
      bearing: map.getBearing(),
      pitch: map.getPitch(),
    },
    resources: Object.fromEntries(
      Object.entries(fileToYamlKey).map(([file, key]) => [
        key.replace(/[A-Z]/g, (m) => `-${m.toLowerCase()}`),
        { file },
      ])
    ),
  };

  zip.file("project-config.yml", jsyaml.dump(projectConfig));

  const blob = await zip.generateAsync({ type: "blob" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "isomizer-project.zip";
  a.click();
  URL.revokeObjectURL(url);
}

async function loadYamlFilesFromZip(zip) {
  await Promise.all(
    Object.entries(fileToYamlKey).map(async ([file, key]) => {
      if (!zip.files[file]) return;
      const text = await zip.file(file).async("text");
      setYaml(key, text);
    })
  );
}

async function loadProjectFromZip(file) {
  const zip = await JSZip.loadAsync(file);

  if (!zip.files["project-config.yml"]) {
    alert("project-config.yml is not present in the ZIP file.");
    return;
  }

  const configText = await zip.file("project-config.yml").async("text");
  projectConfig = jsyaml.load(configText);

  await loadYamlFilesFromZip(zip);
  await renderMap(RenderMode.FULL, { useProjectView: true });
  await switchTab("tab-design-plan");
}

function resolveProjectResourceUrl(baseUrl, file) {
  if (/^https?:\/\//.test(file)) {
    return file;
  }
  return baseUrl + file;
}

async function loadProjectFromUrl(url) {
  const res = await fetch(url);
  const text = await res.text();
  projectConfig = jsyaml.load(text);

  const baseUrl = url.replace(/\/[^/]+$/, "/");

  const resources = projectConfig.resources ?? {};

  for (const [key, { file }] of Object.entries(resources)) {
    const yamlKey = key.replace(/-([a-z])/g, (_, c) => c.toUpperCase());
    const resourceUrl = resolveProjectResourceUrl(baseUrl, file);
    const res = await fetch(resourceUrl);
    const text = await res.text();
    setYaml(yamlKey, text);
  }

  await renderMap(RenderMode.FULL, { useProjectView: true });
  await switchTab("tab-design-plan");
}

/* -------------------------
 * Style generation
 * ------------------------- */

function updateStyle() {
  if (!canRender()) return null;

  const { rules, sources } = getYamlParsed("designPlan");
  return generateStyle(
    rules,
    sources,
    getYamlParsed("symbolPalette")["symbol-palette"],
    getYamlParsed("colorPalette")["color-palette"]
  );
}

/* -------------------------
 * Map helpers
 * ------------------------- */

async function setupContourSource(map) {
  const demSource = new mlcontour.DemSource({
    url: "https://tiles.gsj.jp/tiles/elev/land/{z}/{y}/{x}.png",
    encoding: "numpng",
    maxzoom: 12,
    worker: true,
    cacheSize: 100,
    timeoutMs: 10_000,
  });

  await demSource.setupMaplibre(maplibregl);

  if (!map.getSource("contour-source")) {
    map.addSource("contour-source", {
      type: "vector",
      tiles: [
        demSource.contourProtocolUrl({
          thresholds: {
            10: [80, 400],
            12: [20, 100],
            14: [5, 25],
          },
          contourLayer: "contours",
          elevationKey: "ele",
          levelKey: "level",
          extent: 4096,
          buffer: 1,
        }),
      ],
      maxzoom: 14,
      attribution:
        "<a href='https://tiles.gsj.jp/tiles/elev/tiles.html#land' target='_blank'>産総研 シームレス標高タイル(陸域統合DEM)</a>",
    });
  }
}

function getViewState(map) {
  return {
    center: map.getCenter().toArray(),
    zoom: map.getZoom(),
    bearing: map.getBearing(),
    pitch: map.getPitch(),
  };
}

/* -------------------------
 * Map lifecycle
 * ------------------------- */

async function initializeBlankMap() {
  if (map) map.remove();

  map = new maplibregl.Map({
    container: "map",
    style: { version: 8, sources: {}, layers: [] },
    center: [0, 0],
    zoom: 1,
    hash: true,
  });
}

async function initializeMap(viewState = null) {
  const mapSettings = viewState ?? projectConfig?.map ?? {};

  map = new maplibregl.Map({
    container: "map",
    style: { version: 8, sources: {}, layers: [] },
    center: mapSettings.center ?? [0, 0],
    zoom: mapSettings.zoom ?? 1,
    bearing: mapSettings.bearing ?? 0,
    pitch: mapSettings.pitch ?? 0,
    hash: true,
  });

  await addImages(map, getYamlParsed("imagePalette")["image-palette"]);
  await addSources(map, getYamlParsed("designPlan").sources);
  await setupContourSource(map);

  const style = await updateStyle();
  await addLayers(map, style.layers);

  return map;
}

async function updateImages(map) {
  map
    .getStyle()
    .layers.forEach((l) => map.getLayer(l.id) && map.removeLayer(l.id));
  map.listImages().forEach((id) => map.removeImage(id));

  await addImages(map, getYamlParsed("imagePalette")["image-palette"]);

  const style = await updateStyle();
  await addLayers(map, style.layers);
}

async function renderMap(mode = RenderMode.STYLE_ONLY, options = {}) {
  if (!canRender()) return;

  if (mode === RenderMode.FULL) {
    const useProjectView = options.useProjectView === true;

    const viewState = !useProjectView && map ? getViewState(map) : null;

    if (map) map.remove();
    map = await initializeMap(viewState);
    return;
  }

  if (mode === RenderMode.IMAGES) {
    await updateImages(map);
    return;
  }

  const style = await updateStyle();
  style.layers.forEach((l) => map.getLayer(l.id) && map.removeLayer(l.id));
  await addLayers(map, style.layers);
}

/* -------------------------
 * Editor / UI
 * ------------------------- */

function updateEditor(content, readOnly = false) {
  const editor = document.getElementById("text-editor");
  editor.value = content;
  editor.readOnly = readOnly;
}

async function switchTab(tabId) {
  const mapping = {
    "tab-design-plan": yamlState.designPlan.text,
    "tab-symbol-palette": yamlState.symbolPalette.text,
    "tab-color-palette": yamlState.colorPalette.text,
    "tab-image-palette": yamlState.imagePalette.text,
    "tab-style": JSON.stringify(await updateStyle(), null, 2),
  };

  updateEditor(mapping[tabId], tabId === "tab-style");
  setActiveTab(tabId);
}

function setActiveTab(tabId) {
  document
    .querySelectorAll(".tab")
    .forEach((t) => t.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
}

/* -------------------------
 * Tab handlers
 * ------------------------- */

const yamlKeyMapping = {
  "tab-design-plan": "designPlan",
  "tab-symbol-palette": "symbolPalette",
  "tab-color-palette": "colorPalette",
  "tab-image-palette": "imagePalette",
};

async function handleEditorInput() {
  const activeTab = document.querySelector(".tab.active").id;
  const key = yamlKeyMapping[activeTab];
  if (!key) return;

  const editor = document.getElementById("text-editor");
  setYaml(key, editor.value);

  if (activeTab === "tab-design-plan") {
    await renderMap(RenderMode.FULL);
  } else if (activeTab === "tab-image-palette") {
    await renderMap(RenderMode.IMAGES);
  } else {
    await renderMap(RenderMode.STYLE_ONLY);
  }
}

function getProjectConfigUrlFromQuery() {
  const query = new URLSearchParams(window.location.search);
  return query.get("project");
}

/* -------------------------
 * Bootstrap
 * ------------------------- */

document
  .getElementById("text-editor")
  .addEventListener("input", handleEditorInput);

document
  .querySelectorAll(".tab")
  .forEach((t) => t.addEventListener("click", () => switchTab(t.id)));

document.getElementById("save-zip").addEventListener("click", saveProjectAsZip);

document.getElementById("load-sample").addEventListener("click", async () => {
  await loadProjectFromUrl(sampleProjectUrl);
  await renderMap(RenderMode.FULL, { useProjectView: true });
  await switchTab("tab-design-plan");
});

document.getElementById("load-zip").addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".zip";
  input.onchange = (e) => {
    if (e.target.files[0]) loadProjectFromZip(e.target.files[0]);
  };
  input.click();
});

await initializeBlankMap();
const projectUrl = getProjectConfigUrlFromQuery();

if (projectUrl) {
  await loadProjectFromUrl(projectUrl);
} else {
  switchTab("tab-design-plan");
}
